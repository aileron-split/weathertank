/************************************************************************
   Copyright (C) 2017, Davor Bokun <bokundavor@gmail.com>
*************************************************************************/
const DEG_360=2*Math.PI,DEG_270=1.5*Math.PI,DEG_180=Math.PI,DEG_90=0.5*Math.PI;function createShader(e,a,c){var b=e.createShader(a);e.shaderSource(b,c);e.compileShader(b);var d=e.getShaderParameter(b,e.COMPILE_STATUS);if(d){return b}console.log(e.getShaderInfoLog(b));console.log(c);e.deleteShader(b)}function createProgram(e,d,a){var b=e.createProgram();e.attachShader(b,d);e.attachShader(b,a);e.linkProgram(b);var c=e.getProgramParameter(b,e.LINK_STATUS);if(c){return b}console.log(e.getProgramInfoLog(b));e.deleteProgram(b)}window.onload=function(){var m=document.getElementById("simcanvas");m.width=m.clientWidth;m.height=m.clientHeight;var s=m.getContext("webgl2",{premultipliedAlpha:false});var n=true;ext=s.getExtension("EXT_color_buffer_float");if(!ext){console.log("need EXT_color_buffer_float");return}ext=s.getExtension("OES_texture_float_linear");if(!ext){console.log("No OES_texture_float_linear extension available, falling back to NEAREST");n=false}var w=new Float32Array(2),i=new Float32Array(4),x=new Float32Array(4),Q=[1,1];m.onmousemove=function(aq){w[0]=aq.clientX/m.width;w[1]=1-aq.clientY/m.height;if(!r){C()}};var T=false;window.placeGlider=function(){am.isFlying=false;T=true;document.getElementById("watermark").style.cursor="url('./images/paperplane.png'),pointer";document.getElementById("simcanvas").style.cursor="url('./images/paperplane.png'),pointer"};m.onclick=function(aq){if(T){am.resetLocation(aq.clientX/m.width,1-aq.clientY/m.height);am.isFlying=true;T=false;document.getElementById("watermark").style.cursor=null;document.getElementById("simcanvas").style.cursor=null;p()}};var ab=null;var aa=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.bgTexCoordAttributeLocation=null;this.bgTexCoordBuffer=null;this.resolutionUniformLocation=null;this.backgroundImageTintUniformLocation=null;this.backgroundImageBrightnessUniformLocation=null;this.pressureColorUniformLocation=null;this.pressureOpacityUniformLocation=null;this.pressureCutoffUniformLocation=null;this.pressureIORUniformLocation=null;this.updraftColorUniformLocation=null;this.updraftOpacityUniformLocation=null;this.updraftCutoffUniformLocation=null;this.updraftIORUniformLocation=null;this.cloudColorUniformLocation=null;this.cloudOpacityUniformLocation=null;this.cloudCutoffUniformLocation=null;this.cloudIORUniformLocation=null;this.rainColorUniformLocation=null;this.rainOpacityUniformLocation=null;this.rainCutoffUniformLocation=null;this.rainIORUniformLocation=null;this.humidityColorUniformLocation=null;this.humidityOpacityUniformLocation=null;this.humidityCutoffUniformLocation=null;this.humidityIORUniformLocation=null;this.temperatureColorUniformLocation=null;this.temperatureOpacityUniformLocation=null;this.temperatureCutoffUniformLocation=null;this.temperatureIORUniformLocation=null;this.humidityTemperatureColorUniformLocation=null;this.humidityTemperatureOpacityUniformLocation=null;this.humidityTemperatureCutoffUniformLocation=null;this.humidityTemperatureIORUniformLocation=null;this.relativeTemperatureColorUniformLocation=null;this.relativeTemperatureOpacityUniformLocation=null;this.relativeTemperatureCutoffUniformLocation=null;this.relativeTemperatureIORUniformLocation=null;this.updraftTemperatureColorUniformLocation=null;this.updraftTemperatureOpacityUniformLocation=null;this.updraftTemperatureCutoffUniformLocation=null;this.updraftTemperatureIORUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.backgroundImageTexture=null;this.transferBasefluidTexture=null;this.transferBasefluidFramebuffer=null;this.transferSolutesTexture=null;this.transferSolutesFramebuffer=null;this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_backgroundLocation=null};var S=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.calcFunctionUniformLocation=null;this.resolutionUniformLocation=null;this.diffusionUniformLocation=null;this.buoyancyFactorUniformLocation=null;this.rainFallingFactorUniformLocation=null;this.globalWindUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.heatDisipationRateUniformLocation=null;this.temperatureDiffusionUniformLocation=null;this.humidityDiffusionUniformLocation=null;this.condensationFactorUniformLocation=null;this.mistToRainFactorUniformLocation=null;this.rainFallDiffusionUniformLocation=null;this.mistDiffusionUniformLocation=null;this.rainEvaporationUniformLocation=null;this.initialHumidityUniformLocation=null;this.condensationLevelUniformLocation=null;this.latentHeatUniformLocation=null;this.groundTexture=null;this.basefluidTextures=[];this.basefluidFramebuffers=[];this.solutesTextures=[];this.solutesFramebuffers=[];this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_groundLocation=null};var g=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.normalAttributeLocation=null;this.paperplaneVerticesBuffer=null;this.locationUniformLocation=null;this.directionUniformLocation=null;this.modelTranslationMatUniformLocation=null;this.modelRotationMatUniformLocation=null;this.perspectiveMatUniformLocation=null;this.cloudColorUniformLocation=null;this.cloudOpacityUniformLocation=null;this.cloudCutoffUniformLocation=null;this.cloudIORUniformLocation=null;this.rainColorUniformLocation=null;this.rainOpacityUniformLocation=null;this.rainCutoffUniformLocation=null;this.rainIORUniformLocation=null;this.humidityColorUniformLocation=null;this.humidityOpacityUniformLocation=null;this.humidityCutoffUniformLocation=null;this.humidityIORUniformLocation=null;this.solutesUniformLocation=null;this.wetnessUniformLocation=null;this.modelTranslationMat=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.modelRotationMat=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.perspectiveMat=MDN.perspectiveMatrix(0.1*DEG_90,m.width/m.height,0.01,100);this.location=new Float32Array([0.5,0.5,0]);this.direction=new Float32Array(3);this.heading=0;this.funFactor=5;this.sinkRate=0.07*this.funFactor;this.turnRate=0;this.bankAngle=0;this.pitchAngle=0;this.wobblePhase=0;this.vario=-this.sinkRate;this.wetness=0;this.basefluid=new Float32Array(4);this.solutes=new Float32Array(4);this.turnRateMax=0.01*this.funFactor;this.dryingRate=0.0001;this.speed=0.5*this.funFactor;this.wobbleRate=0.2;this.turnRight=function(){this.turnRate=this.turnRateMax};this.turnLeft=function(){this.turnRate=-this.turnRateMax};this.turnStop=function(){this.turnRate=0};this.resetLocation=function(aq,ar){this.location[0]=aq;this.location[1]=ar};this.isFlying=true;this.stepSimulation=function(){if(this.isFlying){var at=w[0]-this.location[0];if(this.solutes[3]>0.01){at=1}if(at>0){if(this.heading<this.turnRateMax||this.heading>DEG_360-this.turnRateMax){this.turnStop()}else{if(this.turnRate==0){if(this.bankAngle<-5*this.turnRateMax){this.turnRight()}else{this.turnLeft()}}else{if(this.heading>0&&this.heading<DEG_90){this.turnLeft()}if(this.heading>DEG_270&&this.heading<DEG_360){this.turnRight()}}}}else{if(this.heading>DEG_180-this.turnRateMax&&this.heading<DEG_180+this.turnRateMax){this.turnStop()}else{if(this.turnRate==0){if(this.bankAngle>5*this.turnRateMax){this.turnLeft()}else{this.turnRight()}}else{if(this.heading>DEG_90&&this.heading<DEG_180){this.turnRight()}if(this.heading>DEG_180&&this.heading<DEG_270){this.turnLeft()}}}}var aq=[1/m.width,1/m.height];this.heading=(this.heading+this.turnRate)%DEG_360;if(this.heading<0){this.heading+=DEG_360}var ar=(-this.sinkRate-this.wetness+this.basefluid[1]*this.funFactor)*aq[1];this.direction[0]=Math.cos(this.heading);this.direction[1]=ar-this.vario;this.direction[2]=Math.sin(this.heading);this.location[0]+=(this.speed*this.direction[0]+this.basefluid[0]*this.funFactor)*aq[0];this.location[1]+=ar;this.vario=ar;this.wetness+=0.05*this.solutes[1];if(this.wetness>0){this.wetness-=this.dryingRate}if(this.wetness<0){this.wetness=0}this.bankAngle+=0.03*(-15*this.turnRate-this.bankAngle);this.pitchAngle+=0.15*(-400*this.vario-this.pitchAngle);this.wobblePhase+=this.wobbleRate;this.modelTranslationMat=MDN.translateMatrix(0,0,-10-0.1*this.direction[2]);this.modelRotationMat=MDN.multiplyArrayOfMatrices([MDN.rotateYMatrix(this.heading),MDN.rotateZMatrix(this.pitchAngle),MDN.rotateXMatrix(this.bankAngle+0.15*Math.sin(this.wobblePhase)/(1+Math.abs(this.bankAngle))),]);if(this.location[1]<aj-0.015){this.isFlying=false}}};this.doRender=function(){s.useProgram(this.program);ao(null);s.bindBuffer(s.ARRAY_BUFFER,this.paperplaneVerticesBuffer);s.vertexAttribPointer(this.positionAttributeLocation,3,s.FLOAT,false,24,0);s.enableVertexAttribArray(this.positionAttributeLocation);s.vertexAttribPointer(this.normalAttributeLocation,3,s.FLOAT,true,24,12);s.enableVertexAttribArray(this.normalAttributeLocation);s.uniform3fv(this.locationUniformLocation,this.location);s.uniform3fv(this.directionUniformLocation,this.direction);s.uniformMatrix4fv(this.modelTranslationMatUniformLocation,false,this.modelTranslationMat);s.uniformMatrix4fv(this.modelRotationMatUniformLocation,false,this.modelRotationMat);s.uniformMatrix4fv(this.perspectiveMatUniformLocation,false,this.perspectiveMat);s.uniform4fv(this.solutesUniformLocation,this.solutes);s.uniform1f(this.wetnessUniformLocation,this.wetness*7);s.uniform3f(this.cloudColorUniformLocation,b.cloudColor[0]/256,b.cloudColor[1]/256,b.cloudColor[2]/256);s.uniform1f(this.cloudOpacityUniformLocation,b.cloudOpacity);s.uniform1f(this.cloudCutoffUniformLocation,b.cloudCutoff);s.uniform1f(this.cloudIORUniformLocation,b.cloudIOR);s.uniform3f(this.rainColorUniformLocation,b.rainColor[0]/256,b.rainColor[1]/256,b.rainColor[2]/256);s.uniform1f(this.rainOpacityUniformLocation,b.rainOpacity);s.uniform1f(this.rainCutoffUniformLocation,b.rainCutoff);s.uniform1f(this.rainIORUniformLocation,b.rainIOR);s.uniform3f(this.humidityColorUniformLocation,b.humidityColor[0]/256,b.humidityColor[1]/256,b.humidityColor[2]/256);s.uniform1f(this.humidityOpacityUniformLocation,b.humidityOpacity);s.uniform1f(this.humidityCutoffUniformLocation,b.humidityCutoff);s.uniform1f(this.humidityIORUniformLocation,b.humidityIOR);var aq=s.TRIANGLES,at=0,ar=72;s.enable(s.DEPTH_TEST);s.enable(s.BLEND);s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.SRC_ALPHA,s.ONE);s.drawArrays(aq,at,ar);s.disable(s.DEPTH_TEST);s.disable(s.BLEND)}};var U=new aa(),H=new S(),am=new g(),j=new Uint8Array(16*4);function d(){s.bindTexture(s.TEXTURE_2D,H.groundTexture);s.texImage2D(s.TEXTURE_2D,0,s.RGBA,16,1,0,s.RGBA,s.UNSIGNED_BYTE,j)}function f(){var aq=s.createTexture();s.bindTexture(s.TEXTURE_2D,aq);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST);return aq}var r=window.location.hash!="#nostart",N;var E=function(){this.buoyancyFactor=0.01;this.rainFallingFactor=0.01;this.globalWind=0.05;this.globalStability=0.02;this.inversionAltitude=0.9;this.inversionTemperature=0.8;this.groundInversionDepth=0.1;this.groundInversionTemperature=0.3;this.heatDisipationRate=0.0001;this.temperatureDiffusion=0.01;this.humidityDiffusion=0.01;this.condensationFactor=1;this.mistDiffusion=0.01;this.mistToRainFactor=0.001;this.rainFallDiffusion=0.2;this.rainEvaporation=0.00008;this.initialHumidity=0;this.condensationLevel=0.6;this.latentHeat=1;this.stepSize=0.1;this.resolution=256;this.pressureSolveSteps=10;this.diffusion=0.01;this.displayOutline=false;this.backgroundImage=-1;this.backgroundImageTint=[255,255,255];this.backgroundImageBrightness=0;this.pressureColor=[255,0,0];this.pressureOpacity=0;this.pressureCutoff=0;this.pressureIOR=0;this.updraftColor=[255,0,0];this.updraftOpacity=0;this.updraftCutoff=0;this.updraftIOR=0;this.cloudColor=[255,255,255];this.cloudOpacity=1;this.cloudCutoff=0;this.cloudIOR=0;this.rainColor=[120,120,155];this.rainOpacity=1;this.rainCutoff=0;this.rainIOR=0;this.humidityColor=[0,0,255];this.humidityOpacity=1;this.humidityCutoff=0;this.humidityIOR=0;this.temperatureColor=[255,0,0];this.temperatureOpacity=0;this.temperatureCutoff=0;this.temperatureIOR=0;this.humidityTemperatureColor=[255,0,0];this.humidityTemperatureOpacity=0;this.humidityTemperatureCutoff=0;this.humidityTemperatureIOR=0;this.relativeTemperatureColor=[255,0,0];this.relativeTemperatureOpacity=0;this.relativeTemperatureCutoff=0;this.relativeTemperatureIOR=0;this.updraftTemperatureColor=[255,0,0];this.updraftTemperatureOpacity=0;this.updraftTemperatureCutoff=0;this.updraftTemperatureIOR=0;this.runSimulation=function(){if(!r){console.log("START");r=true;requestAnimationFrame(N)}};this.stopSimulation=function(){if(r){r=false;console.log("STOP")}else{console.log("RESET");v()}};this.stepSimulation=function(){if(!r){N();console.log("STEP")}};this.basefluid="";this.solutes=""};var b=new E();function v(aq){m.width=m.clientWidth;m.height=m.clientHeight;ae();J();V();e();I=0;W=1;F=0;R=1;A(H.solutesFramebuffers[W],11);D();p();if(!aq){N()}}function ae(){H.program=createProgram(s,H.vertexShader,H.fragmentShader);H.positionAttributeLocation=s.getAttribLocation(H.program,"a_position");H.positionBuffer=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,H.positionBuffer);var ax=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];s.bufferData(s.ARRAY_BUFFER,new Float32Array(ax),s.STATIC_DRAW);H.texCoordAttributeLocation=s.getAttribLocation(H.program,"a_texCoord");H.texCoordBuffer=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,H.texCoordBuffer);var at=[0,0,0,1,1,0,0,1,1,1,1,0,];s.bufferData(s.ARRAY_BUFFER,new Float32Array(at),s.STATIC_DRAW);H.calcFunctionUniformLocation=s.getUniformLocation(H.program,"u_calcFunction");H.resolutionUniformLocation=s.getUniformLocation(H.program,"u_resolution");H.diffusionUniformLocation=s.getUniformLocation(H.program,"u_diffusion");H.buoyancyFactorUniformLocation=s.getUniformLocation(H.program,"u_buoyancyFactor");H.rainFallingFactorUniformLocation=s.getUniformLocation(H.program,"u_rainFallingFactor");H.globalWindUniformLocation=s.getUniformLocation(H.program,"u_globalWind");H.globalStabilityUniformLocation=s.getUniformLocation(H.program,"u_globalStability");H.inversionAltitudeUniformLocation=s.getUniformLocation(H.program,"u_inversionAltitude");H.inversionTemperatureUniformLocation=s.getUniformLocation(H.program,"u_inversionTemperature");H.groundInversionDepthUniformLocation=s.getUniformLocation(H.program,"u_groundInversionDepth");H.groundInversionTemperatureUniformLocation=s.getUniformLocation(H.program,"u_groundInversionTemperature");H.heatDisipationRateUniformLocation=s.getUniformLocation(H.program,"u_heatDisipationRate");H.temperatureDiffusionUniformLocation=s.getUniformLocation(H.program,"u_temperatureDiffusion");H.humidityDiffusionUniformLocation=s.getUniformLocation(H.program,"u_humidityDiffusion");H.condensationFactorUniformLocation=s.getUniformLocation(H.program,"u_condensationFactor");H.mistDiffusionUniformLocation=s.getUniformLocation(H.program,"u_mistDiffusion");H.mistToRainFactorUniformLocation=s.getUniformLocation(H.program,"u_mistToRainFactor");H.rainFallDiffusionUniformLocation=s.getUniformLocation(H.program,"u_rainFallDiffusion");H.rainEvaporationUniformLocation=s.getUniformLocation(H.program,"u_rainEvaporation");H.initialHumidityUniformLocation=s.getUniformLocation(H.program,"u_initialHumidity");H.condensationLevelUniformLocation=s.getUniformLocation(H.program,"u_condensationLevel");H.latentHeatUniformLocation=s.getUniformLocation(H.program,"u_latentHeat");H.u_basefluidLocation=s.getUniformLocation(H.program,"u_basefluid");H.u_solutesLocation=s.getUniformLocation(H.program,"u_solutes");H.u_groundLocation=s.getUniformLocation(H.program,"u_ground");if(H.groundTexture){s.deleteTexture(H.groundTexture)}H.groundTexture=f();s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT);d();var ay=b.resolution;const ar=0,au=s.RGBA32F,av=0,aC=s.RGBA,aA=s.FLOAT,aw=null;for(var aE=0;aE<2;++aE){var az=f();if(aE<H.basefluidTextures.length){s.deleteTexture(H.basefluidTextures[aE]);H.basefluidTextures[aE]=az}else{H.basefluidTextures.push(az)}s.texImage2D(s.TEXTURE_2D,ar,au,ay,ay,av,aC,aA,aw);var aD=s.createFramebuffer();if(aE<H.basefluidFramebuffers.length){s.deleteFramebuffer(H.basefluidFramebuffers[aE]);H.basefluidFramebuffers[aE]=aD}else{H.basefluidFramebuffers.push(aD)}s.bindFramebuffer(s.FRAMEBUFFER,aD);s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,az,0)}for(aE=0;aE<2;++aE){var aq=f();if(aE<H.solutesTextures.length){s.deleteTexture(H.solutesTextures[aE]);H.solutesTextures[aE]=aq}else{H.solutesTextures.push(aq)}s.texImage2D(s.TEXTURE_2D,ar,au,ay,ay,av,aC,aA,aw);var aB=s.createFramebuffer();if(aE<H.solutesFramebuffers.length){s.deleteFramebuffer(H.solutesFramebuffers[aE]);H.solutesFramebuffers[aE]=aB}else{H.solutesFramebuffers.push(aB)}s.bindFramebuffer(s.FRAMEBUFFER,aB);s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,aq,0)}}function q(){var at=0.5*(m.height/M.height-1),aq=0.5*(m.width/M.width-1),ar=[-aq,1+at,-aq,-at,1+aq,1+at,-aq,-at,1+aq,-at,1+aq,1+at,];s.bindBuffer(s.ARRAY_BUFFER,U.bgTexCoordBuffer);s.bufferData(s.ARRAY_BUFFER,new Float32Array(ar),s.STATIC_DRAW)}var t=0.1,aj=0.1,Z=1.25,Y=0.5*(m.width*(t+1+aj)/(m.height*Z)-1);function ap(){s.bindBuffer(s.ARRAY_BUFFER,U.texCoordBuffer);var aq=[-Y,-aj,-Y,1+t,1+Y,-aj,-Y,1+t,1+Y,1+t,1+Y,-aj,];s.bufferData(s.ARRAY_BUFFER,new Float32Array(aq),s.STATIC_DRAW);Q[0]=m.width/(b.resolution*(1+2*Y));Q[1]=m.height/(b.resolution*(1+t+aj))}function P(){return[(1+2*Y),(1+aj+t)]}function L(ar){var aq=ar[0]*(1+2*Y)-Y,at=ar[1]*(1+aj+t)-aj;aq-=Math.floor(aq);at=Math.min(Math.max(at,0),1);return[aq*o,at*o]}function J(ar){U.program=createProgram(s,U.vertexShader,U.fragmentShader);U.positionAttributeLocation=s.getAttribLocation(U.program,"a_position");U.positionBuffer=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,U.positionBuffer);var aq=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];s.bufferData(s.ARRAY_BUFFER,new Float32Array(aq),s.STATIC_DRAW);U.texCoordAttributeLocation=s.getAttribLocation(U.program,"a_texCoord");U.texCoordBuffer=s.createBuffer();ap();U.bgTexCoordAttributeLocation=s.getAttribLocation(U.program,"a_bgTexCoord");U.bgTexCoordBuffer=s.createBuffer();q();U.resolutionUniformLocation=s.getUniformLocation(U.program,"u_resolution");U.backgroundImageTintUniformLocation=s.getUniformLocation(U.program,"u_backgroundImageTint");U.backgroundImageBrightnessUniformLocation=s.getUniformLocation(U.program,"u_backgroundImageBrightness");U.pressureColorUniformLocation=s.getUniformLocation(U.program,"u_pressureColor");U.pressureOpacityUniformLocation=s.getUniformLocation(U.program,"u_pressureOpacity");U.pressureCutoffUniformLocation=s.getUniformLocation(U.program,"u_pressureCutoff");U.pressureIORUniformLocation=s.getUniformLocation(U.program,"u_pressureIOR");U.updraftColorUniformLocation=s.getUniformLocation(U.program,"u_updraftColor");U.updraftOpacityUniformLocation=s.getUniformLocation(U.program,"u_updraftOpacity");U.updraftCutoffUniformLocation=s.getUniformLocation(U.program,"u_updraftCutoff");U.updraftIORUniformLocation=s.getUniformLocation(U.program,"u_updraftIOR");U.cloudColorUniformLocation=s.getUniformLocation(U.program,"u_cloudColor");U.cloudOpacityUniformLocation=s.getUniformLocation(U.program,"u_cloudOpacity");U.cloudCutoffUniformLocation=s.getUniformLocation(U.program,"u_cloudCutoff");U.cloudIORUniformLocation=s.getUniformLocation(U.program,"u_cloudIOR");U.rainColorUniformLocation=s.getUniformLocation(U.program,"u_rainColor");U.rainOpacityUniformLocation=s.getUniformLocation(U.program,"u_rainOpacity");U.rainCutoffUniformLocation=s.getUniformLocation(U.program,"u_rainCutoff");U.rainIORUniformLocation=s.getUniformLocation(U.program,"u_rainIOR");U.humidityColorUniformLocation=s.getUniformLocation(U.program,"u_humidityColor");U.humidityOpacityUniformLocation=s.getUniformLocation(U.program,"u_humidityOpacity");U.humidityCutoffUniformLocation=s.getUniformLocation(U.program,"u_humidityCutoff");U.humidityIORUniformLocation=s.getUniformLocation(U.program,"u_humidityIOR");U.temperatureColorUniformLocation=s.getUniformLocation(U.program,"u_temperatureColor");U.temperatureOpacityUniformLocation=s.getUniformLocation(U.program,"u_temperatureOpacity");U.temperatureCutoffUniformLocation=s.getUniformLocation(U.program,"u_temperatureCutoff");U.temperatureIORUniformLocation=s.getUniformLocation(U.program,"u_temperatureIOR");U.humidityTemperatureColorUniformLocation=s.getUniformLocation(U.program,"u_humidityTemperatureColor");U.humidityTemperatureOpacityUniformLocation=s.getUniformLocation(U.program,"u_humidityTemperatureOpacity");U.humidityTemperatureCutoffUniformLocation=s.getUniformLocation(U.program,"u_humidityTemperatureCutoff");U.humidityTemperatureIORUniformLocation=s.getUniformLocation(U.program,"u_humidityTemperatureIOR");U.relativeTemperatureColorUniformLocation=s.getUniformLocation(U.program,"u_relativeTemperatureColor");U.relativeTemperatureOpacityUniformLocation=s.getUniformLocation(U.program,"u_relativeTemperatureOpacity");U.relativeTemperatureCutoffUniformLocation=s.getUniformLocation(U.program,"u_relativeTemperatureCutoff");U.relativeTemperatureIORUniformLocation=s.getUniformLocation(U.program,"u_relativeTemperatureIOR");U.updraftTemperatureColorUniformLocation=s.getUniformLocation(U.program,"u_updraftTemperatureColor");U.updraftTemperatureOpacityUniformLocation=s.getUniformLocation(U.program,"u_updraftTemperatureOpacity");U.updraftTemperatureCutoffUniformLocation=s.getUniformLocation(U.program,"u_updraftTemperatureCutoff");U.updraftTemperatureIORUniformLocation=s.getUniformLocation(U.program,"u_updraftTemperatureIOR");U.globalStabilityUniformLocation=s.getUniformLocation(U.program,"u_globalStability");U.inversionAltitudeUniformLocation=s.getUniformLocation(U.program,"u_inversionAltitude");U.inversionTemperatureUniformLocation=s.getUniformLocation(U.program,"u_inversionTemperature");U.groundInversionDepthUniformLocation=s.getUniformLocation(U.program,"u_groundInversionDepth");U.groundInversionTemperatureUniformLocation=s.getUniformLocation(U.program,"u_groundInversionTemperature");U.u_basefluidLocation=s.getUniformLocation(U.program,"u_basefluid");U.u_solutesLocation=s.getUniformLocation(U.program,"u_solutes");U.u_backgroundLocation=s.getUniformLocation(U.program,"u_background");if(U.backgroundImageTexture){s.deleteTexture(U.backgroundImageTexture)}U.backgroundImageTexture=f();s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT);s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,M);if(U.transferBasefluidTexture){s.deleteTexture(U.transferBasefluidTexture)}U.transferBasefluidTexture=f();if(n){s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR)}s.texImage2D(s.TEXTURE_2D,0,s.RGBA32F,b.resolution,b.resolution,0,s.RGBA,s.FLOAT,null);if(U.transferBasefluidFramebuffer){s.deleteFramebuffer(U.transferBasefluidFramebuffer)}U.transferBasefluidFramebuffer=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,U.transferBasefluidFramebuffer);s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,U.transferBasefluidTexture,0);if(U.transferSolutesTexture){s.deleteTexture(U.transferSolutesTexture)}U.transferSolutesTexture=f();if(n){s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR)}s.texImage2D(s.TEXTURE_2D,0,s.RGBA32F,b.resolution,b.resolution,0,s.RGBA,s.FLOAT,null);if(U.transferSolutesFramebuffer){s.deleteFramebuffer(U.transferSolutesFramebuffer)}U.transferSolutesFramebuffer=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,U.transferSolutesFramebuffer);s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,U.transferSolutesTexture,0)}function V(ar){am.program=createProgram(s,am.vertexShader,am.fragmentShader);am.positionAttributeLocation=s.getAttribLocation(am.program,"a_position");am.normalAttributeLocation=s.getAttribLocation(am.program,"a_normal");am.paperplaneVerticesBuffer=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,am.paperplaneVerticesBuffer);var aq=[-0.09996557235717773,0.19790717959403992,-0.09055982530117035,0.02121148072183132,0.5361764430999756,0.8438394069671631,1.2999999523162842,-5.68248026411311e-8,-9.814726809054264e-8,0.02121148072183132,0.5361764430999756,0.8438394069671631,0.8995165228843689,0.17341434955596924,-0.1001209020614624,0.02121148072183132,0.5361764430999756,0.8438394069671631,-0.9999998807907104,0.17341439425945282,-0.10012073069810867,-0,0.9848077893257141,0.17364820837974548,-0.7000001668930054,0.3122909963130951,-0.8877289891242981,-0,0.9848077893257141,0.17364820837974548,-0.9999999403953552,0.3122909963130951,-0.8877289891242981,-0,0.9848077893257141,0.17364820837974548,-0.699999988079071,0.31229105591773987,0.8877291083335876,2.456518899407456e-8,0.9848077297210693,-0.17364811897277832,0.8995163440704346,0.1734144687652588,0.10012083500623703,2.456518899407456e-8,0.9848077297210693,-0.17364811897277832,-0.7000000476837158,0.17341452836990356,0.10012094676494598,2.456518899407456e-8,0.9848077297210693,-0.17364811897277832,-0.9999998807907104,0.17341454327106476,0.10012096911668777,-4.3527411008881245e-8,0.49999991059303284,-0.8660253882408142,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,-4.3527411008881245e-8,0.49999991059303284,-0.8660253882408142,-0.9999998807907104,4.371138473402425e-8,7.549789415861596e-8,-4.3527411008881245e-8,0.49999991059303284,-0.8660253882408142,0.8995165228843689,0.17341434955596924,-0.1001209020614624,8.723878863747814e-8,0.4999999701976776,0.866025447845459,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,8.723878863747814e-8,0.4999999701976776,0.866025447845459,1.2999999523162842,-5.68248026411311e-8,-9.814726809054264e-8,8.723878863747814e-8,0.4999999701976776,0.866025447845459,1.2999999523162842,-5.68248026411311e-8,-9.814726809054264e-8,0.021211348474025726,0.5361765027046204,-0.8438394069671631,-0.09996555745601654,0.19790717959403992,0.09055984020233154,0.021211348474025726,0.5361765027046204,-0.8438394069671631,0.8995163440704346,0.1734144687652588,0.10012083500623703,0.021211348474025726,0.5361765027046204,-0.8438394069671631,-0.09996555745601654,0.19790717959403992,0.09055984020233154,-0.025488976389169693,-0.992059051990509,0.12316243350505829,0.8995163440704346,0.1734144687652588,0.10012083500623703,-0.025488976389169693,-0.992059051990509,0.12316243350505829,-0.699999988079071,0.31229105591773987,0.8877291083335876,-0.025488976389169693,-0.992059051990509,0.12316243350505829,-0.9999998807907104,0.17341439425945282,-0.10012073069810867,9.301992776045154e-8,0.4999999403953552,0.866025447845459,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,9.301992776045154e-8,0.4999999403953552,0.866025447845459,-0.7000000476837158,0.17341437935829163,-0.10012075304985046,9.301992776045154e-8,0.4999999403953552,0.866025447845459,0.8995163440704346,0.1734144687652588,0.10012083500623703,0.015631096437573433,0.4818004071712494,-0.8761415481567383,0.2999999523162842,0.021000539883971214,0.005610767286270857,0.015631096437573433,0.4818004071712494,-0.8761415481567383,0.2999999523162842,0.18654491007328033,0.0966455414891243,0.015631096437573433,0.4818004071712494,-0.8761415481567383,0.8995165228843689,0.17341434955596924,-0.1001209020614624,-0.02548910118639469,-0.9920591115951538,-0.12316228449344635,-0.09996557235717773,0.19790717959403992,-0.09055982530117035,-0.02548910118639469,-0.9920591115951538,-0.12316228449344635,-0.7000001668930054,0.3122909963130951,-0.8877289891242981,-0.02548910118639469,-0.9920591115951538,-0.12316228449344635,0.8995163440704346,0.1734144687652588,0.10012083500623703,-0.014723860658705235,-0.8226855993270874,-0.5683058500289917,0.2999999523162842,0.18654491007328033,0.0966455414891243,-0.014723860658705235,-0.8226855993270874,-0.5683058500289917,-0.09996555745601654,0.19790717959403992,0.09055984020233154,-0.014723860658705235,-0.8226855993270874,-0.5683058500289917,0.8995163440704346,0.1734144687652588,0.10012083500623703,-4.070846415515916e-8,0.4999999701976776,-0.866025447845459,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,-4.070846415515916e-8,0.4999999701976776,-0.866025447845459,-0.7000000476837158,0.17341452836990356,0.10012094676494598,-4.070846415515916e-8,0.4999999701976776,-0.866025447845459,-0.9999998807907104,0.17341454327106476,0.10012096911668777,3.1053485116672164e-8,0.9848077297210693,-0.17364811897277832,-0.699999988079071,0.31229105591773987,0.8877291083335876,3.1053485116672164e-8,0.9848077297210693,-0.17364811897277832,-0.7000000476837158,0.17341452836990356,0.10012094676494598,3.1053485116672164e-8,0.9848077297210693,-0.17364811897277832,0.8995165228843689,0.17341434955596924,-0.1001209020614624,-0.014723292551934719,-0.8226696252822876,0.5683291554450989,-0.09996557235717773,0.19790717959403992,-0.09055982530117035,-0.014723292551934719,-0.8226696252822876,0.5683291554450989,0.2999999523162842,0.18654479086399078,-0.0966455265879631,-0.014723292551934719,-0.8226696252822876,0.5683291554450989,0.2999999523162842,0.021000539883971214,-0.0014001112431287766,0.015944967046380043,0.49863389134407043,0.8666661381721497,0.8995165228843689,0.17341434955596924,-0.1001209020614624,0.015944967046380043,0.49863389134407043,0.8666661381721497,0.2999999523162842,0.18654479086399078,-0.0966455265879631,0.015944967046380043,0.49863389134407043,0.8666661381721497,-0.7000000476837158,0.17341437935829163,-0.10012075304985046,3.452615615628929e-8,0.9848077893257141,0.17364822328090668,0.8995165228843689,0.17341434955596924,-0.1001209020614624,3.452615615628929e-8,0.9848077893257141,0.17364822328090668,-0.7000001668930054,0.3122909963130951,-0.8877289891242981,3.452615615628929e-8,0.9848077893257141,0.17364822328090668,-0.9999998807907104,0.17341439425945282,-0.10012073069810867,6.185376122402886e-8,0.9848077297210693,0.17364820837974548,-0.7000000476837158,0.17341437935829163,-0.10012075304985046,6.185376122402886e-8,0.9848077297210693,0.17364820837974548,-0.7000001668930054,0.3122909963130951,-0.8877289891242981,6.185376122402886e-8,0.9848077297210693,0.17364820837974548,-0.9999998807907104,0.17341454327106476,0.10012096911668777,-3.968867900994155e-8,0.4999999403953552,-0.8660253882408142,-0.7000000476837158,0.17341452836990356,0.10012094676494598,-3.968867900994155e-8,0.4999999403953552,-0.8660253882408142,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,-3.968867900994155e-8,0.4999999403953552,-0.8660253882408142,0.8995165228843689,0.17341434955596924,-0.1001209020614624,8.999531786457737e-8,0.4999999701976776,0.866025447845459,-0.7000000476837158,0.17341437935829163,-0.10012075304985046,8.999531786457737e-8,0.4999999701976776,0.866025447845459,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,8.999531786457737e-8,0.4999999701976776,0.866025447845459,-0.9999998807907104,0.17341439425945282,-0.10012073069810867,8.723880284833285e-8,0.4999999403953552,0.866025447845459,-0.9999998807907104,4.371138473402425e-8,7.549789415861596e-8,8.723880284833285e-8,0.4999999403953552,0.866025447845459,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,8.723880284833285e-8,0.4999999403953552,0.866025447845459,0.8995163440704346,0.1734144687652588,0.10012083500623703,0.005887860897928476,0.5101547837257385,-0.8600624799728394,1.2999999523162842,-5.68248026411311e-8,-9.814726809054264e-8,0.005887860897928476,0.5101547837257385,-0.8600624799728394,0.2999999523162842,0.021000539883971214,0.005610767286270857,0.005887860897928476,0.5101547837257385,-0.8600624799728394,0.8995163440704346,0.1734144687652588,0.10012083500623703,-4.352740390345389e-8,0.49999991059303284,-0.8660253882408142,1.2999999523162842,-5.68248026411311e-8,-9.814726809054264e-8,-4.352740390345389e-8,0.49999991059303284,-0.8660253882408142,-0.7000000476837158,3.059797393234476e-8,5.2848534437544004e-8,-4.352740390345389e-8,0.49999991059303284,-0.8660253882408142,-0.9999998807907104,0.17341454327106476,0.10012096911668777,0,0.9848077297210693,-0.17364810407161713,-0.9999998211860657,0.31229105591773987,0.8877291083335876,0,0.9848077297210693,-0.17364810407161713,-0.699999988079071,0.31229105591773987,0.8877291083335876,0,0.9848077297210693,-0.17364810407161713,0.2999999523162842,0.021000539883971214,-0.0014001112431287766,0.0096502136439085,0.516598105430603,0.8561736941337585,1.2999999523162842,-5.68248026411311e-8,-9.814726809054264e-8,0.0096502136439085,0.516598105430603,0.8561736941337585,0.8995165228843689,0.17341434955596924,-0.1001209020614624,0.0096502136439085,0.516598105430603,0.8561736941337585,];s.bufferData(s.ARRAY_BUFFER,new Float32Array(aq),s.STATIC_DRAW);am.locationUniformLocation=s.getUniformLocation(am.program,"u_location");am.directionUniformLocation=s.getUniformLocation(am.program,"u_direction");am.modelTranslationMatUniformLocation=s.getUniformLocation(am.program,"u_modelTranslationMat");am.modelRotationMatUniformLocation=s.getUniformLocation(am.program,"u_modelRotationMat");am.perspectiveMatUniformLocation=s.getUniformLocation(am.program,"u_perspectiveMat");am.cloudColorUniformLocation=s.getUniformLocation(am.program,"u_cloudColor");am.cloudOpacityUniformLocation=s.getUniformLocation(am.program,"u_cloudOpacity");am.cloudCutoffUniformLocation=s.getUniformLocation(am.program,"u_cloudCutoff");am.cloudIORUniformLocation=s.getUniformLocation(am.program,"u_cloudIOR");am.rainColorUniformLocation=s.getUniformLocation(am.program,"u_rainColor");am.rainOpacityUniformLocation=s.getUniformLocation(am.program,"u_rainOpacity");am.rainCutoffUniformLocation=s.getUniformLocation(am.program,"u_rainCutoff");am.rainIORUniformLocation=s.getUniformLocation(am.program,"u_rainIOR");am.humidityColorUniformLocation=s.getUniformLocation(am.program,"u_humidityColor");am.humidityOpacityUniformLocation=s.getUniformLocation(am.program,"u_humidityOpacity");am.humidityCutoffUniformLocation=s.getUniformLocation(am.program,"u_humidityCutoff");am.humidityIORUniformLocation=s.getUniformLocation(am.program,"u_humidityIOR");am.solutesUniformLocation=s.getUniformLocation(am.program,"u_solutes");am.wetnessUniformLocation=s.getUniformLocation(am.program,"u_wetness")}var O=[];function u(aq){O[aq-1]=true;if(O.every(function(ar){return ar})){v()}}var G=["./images/aileron-grey.png","./images/squares/squares_00.png","./images/squares/squares_01.png","./images/squares/squares_02.png","./images/squares/squares_03.png","./images/hexes/hexes_00.png","./images/hexes/hexes_01.png","./images/aileron.png","./images/aileron-inv.png",];var M=new Image();function K(){if(U.backgroundImageTexture){M.onload=function(){s.bindTexture(s.TEXTURE_2D,U.backgroundImageTexture);s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,M);q();e()};M.src=G[b.backgroundImage]}}var a=new XMLHttpRequest(),al=O.push(false);a.open("GET","shaders/weathersolver.vert",true);a.onload=function(aq){if(this.status==200){H.vertexShader=createShader(s,s.VERTEX_SHADER,a.response);u(al)}};a.send(null);var af=new XMLHttpRequest(),ac=O.push(false);af.open("GET","shaders/weathersolver.frag",true);af.onload=function(aq){if(this.status==200){H.fragmentShader=createShader(s,s.FRAGMENT_SHADER,af.response);u(ac)}};af.send(null);var ah=new XMLHttpRequest(),z=O.push(false);ah.open("GET","shaders/weatherrenderer.vert",true);ah.onload=function(aq){if(this.status==200){U.vertexShader=createShader(s,s.VERTEX_SHADER,ah.response);u(z)}};ah.send(null);var ag=new XMLHttpRequest(),y=O.push(false);ag.open("GET","shaders/weatherrenderer.frag",true);ag.onload=function(aq){if(this.status==200){U.fragmentShader=createShader(s,s.FRAGMENT_SHADER,ag.response);u(y)}};ag.send(null);var h=new XMLHttpRequest();checkIndexVertPaperplane=O.push(false),h.open("GET","shaders/paperplane.vert",true);h.onload=function(aq){if(this.status==200){am.vertexShader=createShader(s,s.VERTEX_SHADER,h.response);u(checkIndexVertPaperplane)}};h.send(null);var X=new XMLHttpRequest();checkIndexFragPaperplane=O.push(false),X.open("GET","shaders/paperplane.frag",true);X.onload=function(aq){if(this.status==200){am.fragmentShader=createShader(s,s.FRAGMENT_SHADER,X.response);u(checkIndexFragPaperplane)}};X.send(null);function l(at){ab=new dat.GUI({load:at});ab.remember(b);var ar=ab.addFolder("Simulation Params");var ax=ar.addFolder("Stability");ax.add(b,"globalWind").min(-1).max(1).step(0.01);ax.add(b,"globalStability").min(0).max(0.5).step(0.01);ax.add(b,"inversionAltitude").min(0.5).max(1).step(0.01);ax.add(b,"inversionTemperature").min(0.5).max(1.5).step(0.01);ax.add(b,"groundInversionDepth").min(0).max(0.5).step(0.01);ax.add(b,"groundInversionTemperature").min(0).max(0.5).step(0.01);ax.add(b,"heatDisipationRate").min(0).max(0.005).step(0.0001);ax.add(b,"buoyancyFactor").min(0).max(0.1).step(0.001);ax.add(b,"rainFallingFactor").min(0).max(0.1).step(0.001);var av=ar.addFolder("Water Content");av.add(b,"temperatureDiffusion").min(0).max(0.1).step(0.01);av.add(b,"humidityDiffusion").min(0).max(0.1).step(0.01);av.add(b,"condensationFactor").min(0).max(1).step(0.01);av.add(b,"mistDiffusion").min(0).max(0.1).step(0.01);av.add(b,"mistToRainFactor").min(0).max(0.01).step(0.0001);av.add(b,"rainFallDiffusion").min(0).max(1).step(0.001);av.add(b,"rainEvaporation").min(0).max(0.001).step(0.00001);av.add(b,"initialHumidity").min(0).max(1).step(0.01);av.add(b,"condensationLevel").min(0).max(1).step(0.01);av.add(b,"latentHeat").min(0).max(5).step(0.1);var aq=ab.addFolder("Solver Settings");aq.add(b,"resolution",[64,128,256,512,1024,2048,4096]).onChange(ad);aq.add(b,"pressureSolveSteps").min(1).max(30).step(1);aq.add(b,"diffusion").min(0).max(1).step(0.01);var aF=ab.addFolder("Display Options");aF.add(b,"displayOutline").onChange(e);aF.add(b,"backgroundImage",[0,1,2,3,4,5,6,7,8]).onChange(K);aF.addColor(b,"backgroundImageTint").onChange(e);aF.add(b,"backgroundImageBrightness").min(-1).max(1).step(0.01).onChange(e);var aE=aF.addFolder("Pressure");aE.addColor(b,"pressureColor").onChange(e);aE.add(b,"pressureOpacity").min(0).max(100000).step(100).onChange(e);aE.add(b,"pressureCutoff").min(0).max(0.01).step(0.00001).onChange(e);aE.add(b,"pressureIOR").min(-100).max(100).step(1).onChange(e);var aD=aF.addFolder("Updraft");aD.addColor(b,"updraftColor").onChange(e);aD.add(b,"updraftOpacity").min(0).max(15).step(0.01).onChange(e);aD.add(b,"updraftCutoff").min(0).max(1).step(0.001).onChange(e);aD.add(b,"updraftIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aC=aF.addFolder("Cloud");aC.addColor(b,"cloudColor").onChange(e);aC.add(b,"cloudOpacity").min(0).max(70).step(0.1).onChange(e);aC.add(b,"cloudCutoff").min(0).max(1).step(0.001).onChange(e);aC.add(b,"cloudIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aB=aF.addFolder("Rain");aB.addColor(b,"rainColor").onChange(e);aB.add(b,"rainOpacity").min(0).max(30).step(0.1).onChange(e);aB.add(b,"rainCutoff").min(0).max(1).step(0.001).onChange(e);aB.add(b,"rainIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aA=aF.addFolder("Humidity");aA.addColor(b,"humidityColor").onChange(e);aA.add(b,"humidityOpacity").min(0).max(15).step(0.1).onChange(e);aA.add(b,"humidityCutoff").min(0).max(1).step(0.001).onChange(e);aA.add(b,"humidityIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var az=aF.addFolder("Temperature");az.addColor(b,"temperatureColor").onChange(e);az.add(b,"temperatureOpacity").min(0).max(15).step(0.1).onChange(e);az.add(b,"temperatureCutoff").min(0).max(1).step(0.001).onChange(e);az.add(b,"temperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ay=aF.addFolder("Humidity Temperature");ay.addColor(b,"humidityTemperatureColor").onChange(e);ay.add(b,"humidityTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ay.add(b,"humidityTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ay.add(b,"humidityTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aw=aF.addFolder("Relative Temperature");aw.addColor(b,"relativeTemperatureColor").onChange(e);aw.add(b,"relativeTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);aw.add(b,"relativeTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);aw.add(b,"relativeTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var au=aF.addFolder("Updraft Temperature");au.addColor(b,"updraftTemperatureColor").onChange(e);au.add(b,"updraftTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);au.add(b,"updraftTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);au.add(b,"updraftTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);ab.add(b,"runSimulation");ab.add(b,"stopSimulation");ab.add(b,"stepSimulation");ab.add(b,"basefluid").listen();ab.add(b,"solutes").listen()}var an=new XMLHttpRequest(),B=O.push(false);an.open("GET","presets.json",true);an.onload=function(ar){if(this.status==200){l(JSON.parse(an.response));var aq=O.push(false);M.onload=function(){u(aq)};M.src=G[b.backgroundImage];u(B)}};an.send(null);function ao(at){var ar,aq;if(at==null){ar=s.canvas.width;aq=s.canvas.height}else{ar=b.resolution;aq=b.resolution}s.bindFramebuffer(s.FRAMEBUFFER,at);s.viewport(0,0,parseFloat(ar),parseFloat(aq))}var F=0,R=1,I=0,W=1;function D(){I=(I==0)?1:0;W=(W==0)?1:0}function ak(){F=(F==0)?1:0;R=(R==0)?1:0}function A(ax,aw){s.useProgram(H.program);s.uniform1i(H.u_basefluidLocation,0);s.uniform1i(H.u_solutesLocation,1);s.uniform1i(H.u_groundLocation,2);s.activeTexture(s.TEXTURE0);s.bindTexture(s.TEXTURE_2D,H.basefluidTextures[F]);s.activeTexture(s.TEXTURE1);s.bindTexture(s.TEXTURE_2D,H.solutesTextures[I]);s.activeTexture(s.TEXTURE2);d();ao(ax);s.uniform1f(H.resolutionUniformLocation,b.resolution);s.enableVertexAttribArray(H.positionAttributeLocation);s.bindBuffer(s.ARRAY_BUFFER,H.positionBuffer);var az=2,av=s.FLOAT,at=false,aq=0,ar=0;s.vertexAttribPointer(H.positionAttributeLocation,az,av,at,aq,ar);s.enableVertexAttribArray(H.texCoordAttributeLocation);s.bindBuffer(s.ARRAY_BUFFER,H.texCoordBuffer);az=2;av=s.FLOAT;at=false;aq=0;ar=0;s.vertexAttribPointer(H.texCoordAttributeLocation,az,av,at,aq,ar);s.uniform1i(H.calcFunctionUniformLocation,aw);s.uniform1f(H.diffusionUniformLocation,b.diffusion);s.uniform1f(H.buoyancyFactorUniformLocation,b.buoyancyFactor);s.uniform1f(H.rainFallingFactorUniformLocation,b.rainFallingFactor);s.uniform1f(H.globalWindUniformLocation,b.globalWind);s.uniform1f(H.globalStabilityUniformLocation,b.globalStability);s.uniform1f(H.inversionAltitudeUniformLocation,b.inversionAltitude);s.uniform1f(H.inversionTemperatureUniformLocation,b.inversionTemperature);s.uniform1f(H.groundInversionDepthUniformLocation,b.groundInversionDepth);s.uniform1f(H.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);s.uniform1f(H.heatDisipationRateUniformLocation,b.heatDisipationRate);s.uniform1f(H.temperatureDiffusionUniformLocation,b.temperatureDiffusion);s.uniform1f(H.humidityDiffusionUniformLocation,b.humidityDiffusion);s.uniform1f(H.condensationFactorUniformLocation,b.condensationFactor);s.uniform1f(H.mistDiffusionUniformLocation,b.mistDiffusion);s.uniform1f(H.mistToRainFactorUniformLocation,b.mistToRainFactor);s.uniform1f(H.rainFallDiffusionUniformLocation,b.rainFallDiffusion);s.uniform1f(H.rainEvaporationUniformLocation,b.rainEvaporation);s.uniform1f(H.initialHumidityUniformLocation,b.initialHumidity);s.uniform1f(H.condensationLevelUniformLocation,b.condensationLevel);s.uniform1f(H.latentHeatUniformLocation,b.latentHeat);var ay=s.TRIANGLES,ar=0,au=6;s.drawArrays(ay,ar,au)}function C(){if(!r&&U.transferBasefluidFramebuffer&&U.transferSolutesFramebuffer){var aq=L(w);s.bindFramebuffer(s.FRAMEBUFFER,U.transferBasefluidFramebuffer);s.readPixels(aq[0],aq[1],1,1,s.RGBA,s.FLOAT,i);ai();s.bindFramebuffer(s.FRAMEBUFFER,U.transferSolutesFramebuffer);s.readPixels(aq[0],aq[1],1,1,s.RGBA,s.FLOAT,x)}b.basefluid=" vx: "+i[0].toFixed(2)+", vy: "+i[1].toFixed(2)+", t: "+x[0].toFixed(3);b.solutes=" h: "+x[2].toFixed(3)+", m: "+x[3].toFixed(3)+", r: "+x[1].toFixed(3)}function ai(){var ar=P(),aq=[256/(o*ar[0]),256/(o*ar[1])];i[0]*=aq[0];i[1]*=aq[1];am.basefluid[0]*=aq[0];am.basefluid[1]*=aq[1]}function p(){var at=L(w),aq=L(am.location);A(U.transferBasefluidFramebuffer,0);s.readPixels(at[0],at[1],1,1,s.RGBA,s.FLOAT,i);s.readPixels(aq[0],aq[1],1,1,s.RGBA,s.FLOAT,am.basefluid);ai();A(U.transferSolutesFramebuffer,1);s.readPixels(at[0],at[1],1,1,s.RGBA,s.FLOAT,x);s.readPixels(aq[0],aq[1],1,1,s.RGBA,s.FLOAT,am.solutes);C();s.useProgram(U.program);s.uniform1i(U.u_basefluidLocation,0);s.uniform1i(U.u_solutesLocation,1);s.uniform1i(U.u_backgroundLocation,2);s.activeTexture(s.TEXTURE0);s.bindTexture(s.TEXTURE_2D,U.transferBasefluidTexture);s.activeTexture(s.TEXTURE1);s.bindTexture(s.TEXTURE_2D,U.transferSolutesTexture);s.activeTexture(s.TEXTURE2);s.bindTexture(s.TEXTURE_2D,U.backgroundImageTexture);ao(null);s.uniform2f(U.resolutionUniformLocation,b.resolution,b.resolution);s.enableVertexAttribArray(U.positionAttributeLocation);s.bindBuffer(s.ARRAY_BUFFER,U.positionBuffer);s.vertexAttribPointer(U.positionAttributeLocation,2,s.FLOAT,false,0,0);s.enableVertexAttribArray(U.texCoordAttributeLocation);s.bindBuffer(s.ARRAY_BUFFER,U.texCoordBuffer);s.vertexAttribPointer(U.texCoordAttributeLocation,2,s.FLOAT,false,0,0);s.enableVertexAttribArray(U.bgTexCoordAttributeLocation);s.bindBuffer(s.ARRAY_BUFFER,U.bgTexCoordBuffer);s.vertexAttribPointer(U.bgTexCoordAttributeLocation,2,s.FLOAT,false,0,0);s.uniform3f(U.backgroundImageTintUniformLocation,b.backgroundImageTint[0]/256,b.backgroundImageTint[1]/256,b.backgroundImageTint[2]/256);s.uniform1f(U.backgroundImageBrightnessUniformLocation,b.backgroundImageBrightness);s.uniform3f(U.pressureColorUniformLocation,b.pressureColor[0]/256,b.pressureColor[1]/256,b.pressureColor[2]/256);s.uniform1f(U.pressureOpacityUniformLocation,b.pressureOpacity);s.uniform1f(U.pressureCutoffUniformLocation,b.pressureCutoff);s.uniform1f(U.pressureIORUniformLocation,b.pressureIOR);s.uniform3f(U.updraftColorUniformLocation,b.updraftColor[0]/256,b.updraftColor[1]/256,b.updraftColor[2]/256);s.uniform1f(U.updraftOpacityUniformLocation,b.updraftOpacity);s.uniform1f(U.updraftCutoffUniformLocation,b.updraftCutoff);s.uniform1f(U.updraftIORUniformLocation,b.updraftIOR);s.uniform3f(U.cloudColorUniformLocation,b.cloudColor[0]/256,b.cloudColor[1]/256,b.cloudColor[2]/256);s.uniform1f(U.cloudOpacityUniformLocation,b.cloudOpacity);s.uniform1f(U.cloudCutoffUniformLocation,b.cloudCutoff);s.uniform1f(U.cloudIORUniformLocation,b.cloudIOR);s.uniform3f(U.rainColorUniformLocation,b.rainColor[0]/256,b.rainColor[1]/256,b.rainColor[2]/256);s.uniform1f(U.rainOpacityUniformLocation,b.rainOpacity);s.uniform1f(U.rainCutoffUniformLocation,b.rainCutoff);s.uniform1f(U.rainIORUniformLocation,b.rainIOR);s.uniform3f(U.humidityColorUniformLocation,b.humidityColor[0]/256,b.humidityColor[1]/256,b.humidityColor[2]/256);s.uniform1f(U.humidityOpacityUniformLocation,b.humidityOpacity);s.uniform1f(U.humidityCutoffUniformLocation,b.humidityCutoff);s.uniform1f(U.humidityIORUniformLocation,b.humidityIOR);s.uniform3f(U.temperatureColorUniformLocation,b.temperatureColor[0]/256,b.temperatureColor[1]/256,b.temperatureColor[2]/256);s.uniform1f(U.temperatureOpacityUniformLocation,b.temperatureOpacity);s.uniform1f(U.temperatureCutoffUniformLocation,b.temperatureCutoff);s.uniform1f(U.temperatureIORUniformLocation,b.temperatureIOR);s.uniform3f(U.humidityTemperatureColorUniformLocation,b.humidityTemperatureColor[0]/256,b.humidityTemperatureColor[1]/256,b.humidityTemperatureColor[2]/256);s.uniform1f(U.humidityTemperatureOpacityUniformLocation,b.humidityTemperatureOpacity);s.uniform1f(U.humidityTemperatureCutoffUniformLocation,b.humidityTemperatureCutoff);s.uniform1f(U.humidityTemperatureIORUniformLocation,b.humidityTemperatureIOR);s.uniform3f(U.relativeTemperatureColorUniformLocation,b.relativeTemperatureColor[0]/256,b.relativeTemperatureColor[1]/256,b.relativeTemperatureColor[2]/256);s.uniform1f(U.relativeTemperatureOpacityUniformLocation,b.relativeTemperatureOpacity);s.uniform1f(U.relativeTemperatureCutoffUniformLocation,b.relativeTemperatureCutoff);s.uniform1f(U.relativeTemperatureIORUniformLocation,b.relativeTemperatureIOR);s.uniform3f(U.updraftTemperatureColorUniformLocation,b.updraftTemperatureColor[0]/256,b.updraftTemperatureColor[1]/256,b.updraftTemperatureColor[2]/256);s.uniform1f(U.updraftTemperatureOpacityUniformLocation,b.updraftTemperatureOpacity);s.uniform1f(U.updraftTemperatureCutoffUniformLocation,b.updraftTemperatureCutoff);s.uniform1f(U.updraftTemperatureIORUniformLocation,b.updraftTemperatureIOR);s.uniform1f(U.globalStabilityUniformLocation,b.globalStability);s.uniform1f(U.inversionAltitudeUniformLocation,b.inversionAltitude);s.uniform1f(U.inversionTemperatureUniformLocation,b.inversionTemperature);s.uniform1f(U.groundInversionDepthUniformLocation,b.groundInversionDepth);s.uniform1f(U.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);var ar=s.TRIANGLES;var av=0;var au=6;s.drawArrays(ar,av,au);am.doRender()}var e=function(){if(b.displayOutline){m.style.border="1px  solid red"}else{m.style.border="none"}if(!r){p()}};var c=function(aq){A(H.basefluidFramebuffers[R],4);ak();for(var ar=1;ar<b.pressureSolveSteps;ar+=1){A(H.basefluidFramebuffers[R],5);ak()}A(H.basefluidFramebuffers[R],6);ak()};function k(aq,ar,at){j[aq*4+0]=ar;j[aq*4+2]=at}N=function(){k(2,70,0);k(3,70,10);k(4,170,10);k(5,70,10);k(8,170,10);k(9,70,0);k(12,0,50);k(13,0,50);A(H.basefluidFramebuffers[R],9);ak();A(H.solutesFramebuffers[W],10);D();A(H.basefluidFramebuffers[R],2);ak();A(H.solutesFramebuffers[W],7);D();c();A(H.basefluidFramebuffers[R],3);ak();A(H.solutesFramebuffers[W],8);D();c();am.stepSimulation();p();if(r){requestAnimationFrame(N)}};var o=256;function ad(aq){if(aq!=o){v(true);o=aq}}};